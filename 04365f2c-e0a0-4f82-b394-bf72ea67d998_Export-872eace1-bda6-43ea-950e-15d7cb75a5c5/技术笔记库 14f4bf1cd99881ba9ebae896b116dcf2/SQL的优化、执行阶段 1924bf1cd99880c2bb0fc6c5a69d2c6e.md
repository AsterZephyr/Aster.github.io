# SQL的优化、执行阶段

Created: 2025年2月6日 09:52
Status: 完成

MySQL 的 SQL 解析和执行过程分为 **解析阶段** 和 **执行阶段**，其中执行阶段又包含预处理、优化和执行三个核心步骤。以下是底层操作的详细分解：

---

## 一、解析阶段：从 SQL 到语法树

### 1. **词法分析（Lexical Analysis）**

- **输入**：原始 SQL 字符串（如 `SELECT name FROM users WHERE age > 30;`）。
- **过程**：
    - 通过 **有限状态机（FSM）** 逐字符扫描，分割为 **Token**（最小语义单元），例如：
        
        ```
        [SELECT] [name] [FROM] [users] [WHERE] [age] [>] [30] [;]
        
        ```
        
    - 区分 **关键词**（`SELECT`, `FROM`）、**标识符**（表名 `users`、列名 `age`）、**操作符**（`>`）和 **字面量**（`30`）。
- **底层实现**：MySQL 手写词法分析器（`sql/sql_lex.cc`），避免自动生成工具的冗余，提升性能[2][7]。

### 2. **语法分析（Syntax Analysis）**

- **输入**：词法分析生成的 Token 流。
- **过程**：
    - 使用 **Bison 生成的 LALR(1) 语法解析器**（`sql/sql_yacc.y`），根据 SQL 语法规则构建 **抽象语法树（AST）**。
    - 例如，`SELECT` 查询会被解析为 `PT_select_stmt` 节点，包含 `FROM` 子表、`WHERE` 条件子树等[3][8]。
- **输出**：AST 结构（如 MySQL 的 `Query_block` 和 `Query_expression` 类）[8]。

---

## 二、执行阶段：从语法树到结果集

### 1. **预处理阶段（Preprocessing）**

- **输入**：解析后的 AST。
- **核心操作**：
    - **语义验证**：
        - 检查表和列是否存在（通过数据字典 `information_schema`）[4][11]。
        - 解析别名和视图（如将视图 `employees_list` 替换为基表查询）[8]。
    - **符号扩展**：
        - 将 `SELECT *` 扩展为所有列名（基于表结构）[5][37]。
    - **权限检查**：验证用户对表和列的访问权限[4][39]。

### 2. **优化阶段（Optimization）**

- **目标**：生成 **最低成本的执行计划**。
- **关键步骤**：
    - **逻辑优化**：
        - 子查询转换为 `JOIN`（如 `WHERE EXISTS` 优化为 `SEMI JOIN`）[11][27]。
        - 谓词下推（将过滤条件提前到数据读取阶段）[25][33]。
    - **物理优化**：
        - **成本模型**：基于统计信息（表大小、索引基数）估算不同执行计划的 I/O 和 CPU 成本[6][27]。
        - **索引选择**：决定使用全表扫描还是索引扫描（如 `age > 30` 选择 `INDEX(age)`）[6][33]。
        - **连接顺序优化**：多表连接时动态调整顺序（如小表驱动大表）[25][27]。
    - **输出**：最终执行计划（`EXPLAIN` 输出）[6][31]。

### 3. **执行阶段（Execution）**

- **输入**：优化后的执行计划。
- **操作流程**：
    1. **执行引擎调用存储引擎**：
    - 通过 `handler` API（如 `ha_innobase`）从 InnoDB 缓冲池或磁盘读取数据[4][9]。
    1. **数据处理**：
    - **过滤**：应用 `WHERE` 条件（如 `age > 30`）。
    - **排序/分组**：使用临时表或文件排序（如 `ORDER BY data`）[5][33]。
    1. **结果返回**：
    - 通过 **网络协议层**（如 MySQL 协议）将结果集返回客户端[5][9]。

---

## 三、关键技术对比

| 阶段 | 技术点 | MySQL 实现 | 替代方案（如 PostgreSQL） |
| --- | --- | --- | --- |
| **词法分析** | 分词方式 | 手写有限状态机（性能优先）[2][7] | Flex 自动生成（灵活性优先） |
| **语法分析** | 解析算法 | Bison 生成的 LALR(1) 解析器[3][8] | 自顶向下的递归下降解析器 |
| **优化器** | 成本模型 | 基于统计信息和启发式规则[6][27] | 基于遗传算法或机器学习模型 |
| **执行引擎** | 数据访问接口 | `handler` API 抽象存储引擎[4][9] | 存储引擎深度集成（如 WiredTiger） |
|  |  |  |  |

---

## 四、性能优化示例

### 场景：`SELECT * FROM orders WHERE user_id=100 ORDER BY create_time DESC LIMIT 10;`

1. **索引选择**：优化器可能选择 `INDEX(user_id, create_time)` 避免排序[33]。
2. **执行计划**：
    
    ```sql
    EXPLAIN FORMAT=TREE
    SELECT * FROM orders WHERE user_id=100 ORDER BY create_time DESC LIMIT 10;
    -- 输出：
    -> Limit: 10 row(s)
        -> Index scan backward on orders using idx_user_create (user_id=100)
    
    ```
    
3. **成本估算**：索引扫描成本远低于全表扫描+排序[6][31]。

---

通过这一流程，MySQL 将 SQL 查询转化为高效的数据操作，其设计平衡了语法灵活性、执行性能和维护成本[7][25][33]。

Citations:
[1] [https://stackoverflow.com/questions/23038620/reusing-mysql-parser](https://stackoverflow.com/questions/23038620/reusing-mysql-parser)
[2] [https://tigercosmos.github.io/lets-build-dbms/days/8.html](https://tigercosmos.github.io/lets-build-dbms/days/8.html)
[3] [https://dev.mysql.com/doc/dev/mysql-server/9.1.0/CODE_PATH_CREATE_TABLE.html](https://dev.mysql.com/doc/dev/mysql-server/9.1.0/CODE_PATH_CREATE_TABLE.html)
[4] [https://distributedsystemsauthority.com/mysql-performance-tuning-part-1/](https://distributedsystemsauthority.com/mysql-performance-tuning-part-1/)
[5] [https://www.designgurus.io/blog/sql-query-execution-process](https://www.designgurus.io/blog/sql-query-execution-process)
[6] [https://nomadicsoft.io/demystifying-mysql-query-execution-plans-understanding-the-explain-plan-for-efficient-mysql-query-optimization/](https://nomadicsoft.io/demystifying-mysql-query-execution-plans-understanding-the-explain-plan-for-efficient-mysql-query-optimization/)
[7] [https://www.alibabacloud.com/blog/design-and-practice-of-self-developed-sql-parser_598414](https://www.alibabacloud.com/blog/design-and-practice-of-self-developed-sql-parser_598414)
[8] [https://www.alibabacloud.com/blog/598909](https://www.alibabacloud.com/blog/598909)
[9] [https://blog.bytebytego.com/p/what-happens-when-a-sql-is-executed](https://blog.bytebytego.com/p/what-happens-when-a-sql-is-executed)
[10] [https://seattledataguy.substack.com/p/behind-the-scenes-of-sql-understanding](https://seattledataguy.substack.com/p/behind-the-scenes-of-sql-understanding)
[11] [https://www.rapydo.io/blog/mysql-optimizer-a-comprehensive-guide](https://www.rapydo.io/blog/mysql-optimizer-a-comprehensive-guide)
[12] [https://patents.google.com/patent/CN105787044A/en](https://patents.google.com/patent/CN105787044A/en)
[13] [https://blog.hatena.ne.jp/login?blog=https%3A%2F%2Fmemo.geso.site%2Fentry%2F2024%2F09%2F26%2F201021](https://blog.hatena.ne.jp/login?blog=https%3A%2F%2Fmemo.geso.site%2Fentry%2F2024%2F09%2F26%2F201021)
[14] [https://github.com/enhancedformysql/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/blob/main/Chapter4_5.md](https://github.com/enhancedformysql/The-Art-of-Problem-Solving-in-Software-Engineering_How-to-Make-MySQL-Better/blob/main/Chapter4_5.md)
[15] [https://stackoverflow.com/questions/3812621/handling-tree-in-a-mysql-procedure](https://stackoverflow.com/questions/3812621/handling-tree-in-a-mysql-procedure)
[16] [https://www.freecodecamp.org/news/gql-design-and-implementation/](https://www.freecodecamp.org/news/gql-design-and-implementation/)
[17] [https://www.semanticscholar.org/paper/Design-and-implementation-of-a-general-SQL-parser-Wu-Di/6ca230bc23ea919ef6d8caee6bee42b41289e22b](https://www.semanticscholar.org/paper/Design-and-implementation-of-a-general-SQL-parser-Wu-Di/6ca230bc23ea919ef6d8caee6bee42b41289e22b)
[18] [https://dev.mysql.com/doc/dev/mysql-server/8.4.3/stored_programs.html](https://dev.mysql.com/doc/dev/mysql-server/8.4.3/stored_programs.html)
[19] [https://dev.mysql.com/doc/dev/mysql-server/latest/group__GROUP__PARSER.html](https://dev.mysql.com/doc/dev/mysql-server/latest/group__GROUP__PARSER.html)
[20] [https://github.com/phpmyadmin/sql-parser](https://github.com/phpmyadmin/sql-parser)
[21] [https://dev.mysql.com/blog-archive/parsing-in-mysql-workbench/](https://dev.mysql.com/blog-archive/parsing-in-mysql-workbench/)
[22] [https://www.researchgate.net/figure/SQL-parse-tree-of-an-SQL-injection_fig1_237102618](https://www.researchgate.net/figure/SQL-parse-tree-of-an-SQL-injection_fig1_237102618)
[23] [https://github.com/nene/sql-parser-cst](https://github.com/nene/sql-parser-cst)
[24] [https://www.datacamp.com/tutorial/sql-order-of-execution](https://www.datacamp.com/tutorial/sql-order-of-execution)
[25] [https://www.alibabacloud.com/blog/about-database-kernel-|-how-does-polardb-htap-implement-imci-query-optimization_600271](https://www.alibabacloud.com/blog/about-database-kernel-%7C-how-does-polardb-htap-implement-imci-query-optimization_600271)
[26] [https://stackoverflow.com/questions/31435326/sql-view-progress-of-query](https://stackoverflow.com/questions/31435326/sql-view-progress-of-query)
[27] [https://stackoverflow.com/questions/48790264/how-mysql-query-plan-is-generated](https://stackoverflow.com/questions/48790264/how-mysql-query-plan-is-generated)
[28] [https://cloud.google.com/bigquery/docs/best-practices-performance-compute](https://cloud.google.com/bigquery/docs/best-practices-performance-compute)
[29] [https://dev.mysql.com/doc/refman/8.4/en/show-processlist.html](https://dev.mysql.com/doc/refman/8.4/en/show-processlist.html)
[30] [https://dba.stackexchange.com/questions/197969/how-mysql-query-plan-is-generated](https://dba.stackexchange.com/questions/197969/how-mysql-query-plan-is-generated)
[31] [https://dev.mysql.com/doc/refman/8.4/en/execution-plan-information.html](https://dev.mysql.com/doc/refman/8.4/en/execution-plan-information.html)
[32] [https://dev.mysql.com/doc/refman/8.4/en/explain.html](https://dev.mysql.com/doc/refman/8.4/en/explain.html)
[33] [https://www.percona.com/blog/improving-mysql-query-performance/](https://www.percona.com/blog/improving-mysql-query-performance/)
[34] [https://bugs.mysql.com/bug.php?id=111225](https://bugs.mysql.com/bug.php?id=111225)
[35] [https://dba.stackexchange.com/questions/15371/how-do-i-get-the-execution-plan-for-a-view](https://dba.stackexchange.com/questions/15371/how-do-i-get-the-execution-plan-for-a-view)
[36] [https://www.mydbops.com/blog/demystifying-mysqls-explain-format-tree-and-understanding-query-execution](https://www.mydbops.com/blog/demystifying-mysqls-explain-format-tree-and-understanding-query-execution)
[37] [https://docs.getdbt.com/blog/sql-comprehension-technologies](https://docs.getdbt.com/blog/sql-comprehension-technologies)
[38] [https://builtin.com/data-science/sql-order-of-execution](https://builtin.com/data-science/sql-order-of-execution)
[39] [https://dbeaver.com/docs/dbeaver/Query-Execution-Plan/](https://dbeaver.com/docs/dbeaver/Query-Execution-Plan/)
[40] [https://dev.to/dbdeveloper/mysql-analyze-query-execution-plans-how-to-reach-top-query-speedmemory-storage-engine-5b5](https://dev.to/dbdeveloper/mysql-analyze-query-execution-plans-how-to-reach-top-query-speedmemory-storage-engine-5b5)

---